# Claude Usage Telemetry & Go/NoGo Gate

## 背景

claude-usage は現在、macOS メニューバーに Claude.ai の残クォータを表示する SwiftBar プラグインである。
表示はできるが、その情報に基づいて **アクションを起こす** 仕組みがない。

一方、Claude Code (CLI) を Cron で定期実行し、コーディングタスクを自動処理するワークフローが普及しつつある。
しかし、自動タスクがクォータを消費しすぎると **手動で使いたいときに使えない** 問題が発生する。

## 誰に対して

**Claude Code CLI を Cron 等で自動実行している開発者**（個人〜小規模チーム）

- Claude.ai の Pro/Max サブスクリプションを利用している
- 限られたレートリミット枠の中で、自動タスクと手動利用を両立させたい
- OSS として公開し、同じ課題を持つ開発者が利用できるようにする

## 何の課題を解決するか

1. **クォータ枯渇の防止**: 自動タスクが残クォータを食い尽くし、手動で Claude を使いたいときに使えなくなることを防ぐ
2. **使用量の最適化**: 限られたクォータを無駄なく使い切る（余らせすぎず、使いすぎず）

## 課題が起きるシナリオ（具体例）

```
08:00  Cron が Claude Code タスクを3つ起動
08:30  5時間枠の使用量が 90% に到達
09:00  開発者が手動で Claude Code を使おうとする → レートリミット到達で使えない
09:00  残りの Cron タスクも無駄にリトライし続ける
→ 5時間枠のリセットまで待つしかない
```

## 解決後の姿

```
08:00  Cron がラッパースクリプト経由で Claude Code タスクを起動
       ラッパーが残クォータを確認 → 余裕あり → Go → タスク実行
08:30  次の Cron 起動 → ラッパーが残クォータ確認 → 80%超 → NoGo → タスク中止
09:00  開発者が手動で Claude Code を使う → クォータに余裕がある → 快適に利用
```

## 設計方針

### 確定事項

- **クォータ情報源**: 既存の claude.ai API (`/api/organizations/{uuid}/usage`)
- **判断スコープ**: アカウント全体で1つの Go/NoGo 判断（プロジェクト単位ではない）
- **実行対象**: Claude Code CLI (`claude` コマンド)

### 未確定事項（今後の設計で決定）

- テレメトリのイベント送信方式（P2P / キュー / ファイルベース / etc.）
- Go/NoGo の閾値設定方法
- タスクの優先度制御の有無
- ラッパースクリプトの言語・形式
